---
- name: Configuration DevSecOps du serveur
  hosts: all
  become: yes
  tasks:
    # 1. Installation de Docker 
    - name: Installer Docker
      apt:
        name: [docker.io, docker-compose]
        state: present
        update_cache: yes

    # 2. Sécurité : Bonnes pratiques 
    - name: Configurer le pare-feu UFW
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop: ['22', '80', '3000', '9000', '9090']

    # 3. Installation de Trivy 
    - name: Installer Trivy
      shell: |
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | apt-key add -
        echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | tee -a /etc/apt/sources.list.d/trivy.list
        apt-get update && apt-get install trivy -y

    # 4. Déploiement SonarQube, Prometheus, Grafana 
    - name: Créer le fichier docker-compose pour les outils
      copy:
        dest: /home/ubuntu/docker-compose.yml
        content: |
          version: '3'
          services:
            sonarqube:
              image: sonarqube:lts
              ports: ["9000:9000"]
            prometheus:
              image: prom/prometheus
              ports: ["9090:9090"]
            grafana:
              image: grafana/grafana
              ports: ["3000:3000"]
            node-exporter:
              image: prom/node-exporter
              ports: ["9100:9100"]

    - name: Lancer les containers
      shell: docker-compose -f /home/ubuntu/docker-compose.yml up -d